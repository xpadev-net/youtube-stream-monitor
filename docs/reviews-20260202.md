ä»•æ§˜æ›¸ vs å®Ÿè£… ãƒ¬ãƒ“ãƒ¥ãƒ¼
æ¦‚è¦
docs/requirements.md ã®ä»•æ§˜ã«å¯¾ã—ã¦å®Ÿè£…å…¨ä½“ã‚’ç…§åˆã—ã¾ã—ãŸã€‚å¤§éƒ¨åˆ†ã¯ä»•æ§˜ã«æº–æ‹ ã—ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã«é½Ÿé½¬ãƒ»æ‡¸å¿µç‚¹ã‚’åˆ—æŒ™ã—ã¾ã™ã€‚
---
é‡å¤§ãªé½Ÿé½¬ (High)
1. monitors.id ã‚«ãƒ©ãƒ é•·ã®ä¸ä¸€è‡´
- ä»•æ§˜: VARCHAR(37) (Â§9.1)
- å®Ÿè£…: VARCHAR(73) (migrations/001_initial_schema.sql:6)
- mon- (4æ–‡å­—) + UUID with hyphens (36æ–‡å­—) = 40æ–‡å­—ã€‚ä»•æ§˜ã®37ã¯ä¸è¶³ã€å®Ÿè£…ã®73ã¯éå¤§ã€‚æ­£ã—ãã¯ VARCHAR(40) ç¨‹åº¦ãŒé©åˆ‡ã€‚
2. å†…éƒ¨APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£å½¢å¼ãŒä»•æ§˜ã¨ç•°ãªã‚‹
- ä»•æ§˜ (Â§8.6): health ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ statistics ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒã‚¹ãƒˆã—ãŸå½¢å¼
{"status":"monitoring","health":{"video":"ok","audio":"ok"},"statistics":{"total_segments_analyzed":150,...}}
- å®Ÿè£… (handlers.go:381-391): ãƒ•ãƒ©ãƒƒãƒˆåŒ–ã•ã‚ŒãŸ video_health, audio_health, stream_status ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ stats ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
{"status":"monitoring","video_health":"ok","audio_health":"ok","stats":{"total_segments":150,...}}
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚‚ç•°ãªã‚‹ï¼ˆtotal_segments_analyzed vs total_segmentsï¼‰
3. Webhooké€ä¿¡æ™‚ã®X-TimestampãŒãƒªãƒˆãƒ©ã‚¤ã§æ›´æ–°ã•ã‚Œãªã„
- ä»•æ§˜ (Â§12.2.1): X-Timestamp ã¯ã€Œãƒªãƒˆãƒ©ã‚¤æ™‚ã«æ›´æ–°ã•ã‚Œã‚‹ã€
- å®Ÿè£… (webhook.go:72-135): Send() ã§payloadã®marshalã¯1å›ã ã‘è¡Œã„ã€ãƒªãƒˆãƒ©ã‚¤ãƒ«ãƒ¼ãƒ—å†…ã® sendOnce() ã§æ¯å› time.Now().Unix()
ã‚’å–å¾—ã—ã¦ã„ã‚‹ã®ã§X-Timestampã¯æ›´æ–°ã•ã‚Œã‚‹ã€‚ãŸã ã—Signatureã‚‚å†è¨ˆç®—ã•ã‚Œã‚‹ãŸã‚å•é¡Œãªã—ã€‚â†’ ã“ã‚Œã¯æ­£ã—ã„å®Ÿè£…ã€‚
4. Webhooké€ä¿¡æ™‚ã®payload timestampãŒãƒªãƒˆãƒ©ã‚¤ã§å¤‰ã‚ã‚‰ãªã„ä¿è¨¼ãŒãªã„
- ä»•æ§˜ (Â§4.4): timestampï¼ˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å†…ï¼‰ã¯ãƒªãƒˆãƒ©ã‚¤æ™‚ã‚‚åˆå›ç”Ÿæˆæ™‚ã®å€¤ã‚’ä¿æŒ
- å®Ÿè£…: Send() ã§payloadã®JSON marshalã¯æœ€åˆã«1å›ã ã‘è¡Œã‚ã‚Œã€bodyãƒã‚¤ãƒˆåˆ—ã‚’å†åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€payloadå†…ã®timestampã¯å¤‰ã‚ã‚‰ãªã„ã€‚â†’
æ­£ã—ã„å®Ÿè£…ã€‚
5. Podä»•æ§˜ã«volume/volumeMountsãŒæœªå®Ÿè£…
- ä»•æ§˜ (Â§8.1): emptyDir ãƒœãƒªãƒ¥ãƒ¼ãƒ  workdir ã‚’ /tmp/segments ã«ãƒã‚¦ãƒ³ãƒˆ
- å®Ÿè£… (k8s.go:141-184): Podä½œæˆã«Volumesã¨VolumeMountsã®æŒ‡å®šãŒãªã„
- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãŒãƒ›ã‚¹ãƒˆã® /tmp ã«ä¾å­˜ã—ã¦ã—ã¾ã„ã€Podå‰Šé™¤æ™‚ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒä¿è¨¼ã•ã‚Œãªã„
6. Podãƒªã‚½ãƒ¼ã‚¹requests/limitsãŒæœªè¨­å®š
- ä»•æ§˜ (Â§8.1): requests: {memory: 256Mi, cpu: 100m}, limits: {memory: 512Mi, cpu: 500m}
- å®Ÿè£… (k8s.go:180): Resources: corev1.ResourceRequirements{} â€” ç©º
7. terminationGracePeriodSecondsãŒæœªè¨­å®š
- ä»•æ§˜ (Â§8.3): terminationGracePeriodSeconds: 30
- å®Ÿè£…: PodSpecã«æŒ‡å®šãªã—ï¼ˆKubernetes defaultã¯30ç§’ãªã®ã§å¶ç„¶ä¸€è‡´ã—ã¦ã„ã‚‹ãŒæ˜ç¤ºã™ã¹ãï¼‰
---
ä¸­ç¨‹åº¦ã®é½Ÿé½¬ (Medium)
8. ç’°å¢ƒå¤‰æ•°åã®ä¸ä¸€è‡´
- ä»•æ§˜ (Â§14.2): DB_DSN, GATEWAY_RECONCILE_TIMEOUT
- å®Ÿè£… (config.go): DATABASE_URL, RECONCILE_TIMEOUT
9. Waiting Modeã®ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”
- ä»•æ§˜ (Â§7.5): é…ä¿¡é–‹å§‹å‰=30ç§’ã€äºˆå®šæ™‚åˆ»è¶…éå¾Œ=10ç§’
- å®Ÿè£… (config.go:137): WaitingModeInterval ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60ç§’ã§å›ºå®šã€‚äºˆå®šæ™‚åˆ»è¶…éå¾Œã«10ç§’ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãªã—ã€‚
10. ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰åã®ä¸ä¸€è‡´
- ä»•æ§˜ (Â§3.5): INVALID_CONFIG, RATE_LIMIT_EXCEEDED, MAX_MONITORS_EXCEEDED
- å®Ÿè£… (errors.go): MAX_MONITORS_REACHEDï¼ˆä»•æ§˜ã¯ MAX_MONITORS_EXCEEDEDï¼‰ã€INVALID_CONFIG ã¨ RATE_LIMIT_EXCEEDED ãŒæœªå®šç¾©
11. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæœªå®Ÿè£…
- ä»•æ§˜ (Â§12.3): ç›£è¦–ä½œæˆ10å›/åˆ†ã€çŠ¶æ…‹ç…§ä¼š100å›/åˆ†
- å®Ÿè£…: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãªã—
12. å†æ•´åˆã®monitor.error Webhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å½¢å¼ãŒä»•æ§˜ã¨ç•°ãªã‚‹
- ä»•æ§˜ (Â§10.4): reconciliation_action, previous_status, observed_state ã‚’å«ã‚€è©³ç´°ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
- å®Ÿè£… (reconcile.go:193-197): reason ã¨ message ã®ã¿ã®ç°¡ç´ ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
13. è§£æã‚µã‚¤ã‚¯ãƒ«ã®ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼åˆ¶å¾¡ãŒä¸å®Œå…¨
- ä»•æ§˜ (Â§6.2): è§£ææ™‚é–“ >= check_interval_secã®å ´åˆã¯å¾…æ©Ÿãªã—ã§å³åº§ã«æ¬¡ã‚µã‚¤ã‚¯ãƒ«
- å®Ÿè£… (worker.go:218): time.NewTicker ã‚’ä½¿ç”¨ã€‚tickerã¯ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è£œæ­£ã™ã‚‹ãŒã€è§£æä¸­ã®tickã¯ç ´æ£„ã•ã‚Œã‚‹ãŸã‚æ„å‘³çš„ã«ã¯è¿‘ã„ãŒã€ä»•æ§˜ã®ã€Œ
è§£æå®Œäº†ã¾ã§æ¬¡ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå–å¾—ã¯è¡Œã‚ãªã„ã€ã¯ select
ã§manifestRefreshTickerã¨åŒæ™‚ã«listenã—ã¦ã„ã‚‹ãŸã‚ã€è§£æä¸­ã«ã‚‚ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆæ›´æ–°ãŒèµ°ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
14. EXT-X-ENDLISTã«ã‚ˆã‚‹é…ä¿¡çµ‚äº†æ¤œå‡ºãŒæœªå®Ÿè£…
- ä»•æ§˜ (Â§7.6): æœ€å„ªå…ˆã®çµ‚äº†æ¤œå‡ºæ–¹æ³•
- å®Ÿè£…: manifestè§£æçµæœã‹ã‚‰ENDLISTã‚’ç¢ºèªã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒè¦‹å½“ãŸã‚‰ãªã„
15. å®šæœŸçš„ãªis_liveãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†é–“éš”ï¼‰ãŒæœªå®Ÿè£…
- ä»•æ§˜ (Â§7.6): monitoringä¸­ã‚‚5åˆ†é–“éš”ã§is_liveã‚’ç¢ºèª
- å®Ÿè£…: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼60ç§’ç¶™ç¶šæ™‚ã«ã®ã¿is_liveã‚’ç¢ºèª
---
è»½å¾®ãªé½Ÿé½¬ (Low)
16. Podã‚³ãƒ³ãƒ†ãƒŠå
- ä»•æ§˜ (Â§8.1): name: monitor
- å®Ÿè£… (k8s.go:153): name: worker
17. Probeã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨å¤±æ•—é–¾å€¤ãŒæœªè¨­å®š
- ä»•æ§˜ (Â§8.7): timeout: 5ç§’, failureThreshold: 3å›
- å®Ÿè£…: Probeã« TimeoutSeconds ã¨ FailureThreshold ã®æŒ‡å®šãªã—ï¼ˆKubernetes default: 1ç§’, 3å›ï¼‰
18. ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ãŒæœªå®Ÿè£…
- ä»•æ§˜ (Â§10.3): 5å›é€£ç¶šå¤±æ•—ã§ã‚ªãƒ¼ãƒ—ãƒ³ã€30ç§’ç¶­æŒ
- å®Ÿè£…: ãªã—
19. blackout/silence Webhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã« segment_info ãŒå«ã¾ã‚Œãªã„
- ä»•æ§˜ (Â§4.3): segment_info: {sequence, duration} ã‚’å«ã‚€
- å®Ÿè£… (worker.go:334-338): duration_sec, started_at, threshold_sec ã®ã¿
20. stream.ended Webhookã« data ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„
- ä»•æ§˜: ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«æ™‚ã«dataã‚’å«ã‚€ã¹ã
- å®Ÿè£… (worker.go:435): w.sendWebhook(ctx, webhook.EventStreamEnded, nil) â€” dataãŒnil
---
ã¾ã¨ã‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡è¦åº¦ â”‚ ä»¶æ•° â”‚                                 ä¸»ãªå†…å®¹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ High   â”‚ 5ä»¶  â”‚ Volumeæœªå®Ÿè£…ã€ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™æœªè¨­å®šã€å†…éƒ¨APIãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å½¢å¼ä¸ä¸€è‡´ã€DBåˆ—å¹…    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Medium â”‚ 8ä»¶  â”‚ ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€ENDLISTæ¤œå‡ºã€is_liveãƒã‚§ãƒƒã‚¯   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Low    â”‚ 5ä»¶  â”‚ ã‚³ãƒ³ãƒ†ãƒŠåã€Probeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã€Webhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰è©³ç´° â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç‰¹ã« Podä»•æ§˜ï¼ˆVolume, Resources, terminationGracePeriodï¼‰ ã¨ å†…éƒ¨APIãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å½¢å¼ ã¯ä»•æ§˜ã¨ã®ä¹–é›¢ãŒå¤§ããã€å„ªå…ˆçš„ã«å¯¾å¿œã™ã¹ãã§ã™ã€‚
---
ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å…¨ä½“ãƒ¬ãƒ“ãƒ¥ãƒ¼
æ¦‚è¦
YouTubeé…ä¿¡ç›£è¦–ã®Kubernetesãƒã‚¤ãƒ†ã‚£ãƒ–ãªãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã€‚Gateway (API) ã¨ Worker (é…ä¿¡è§£æ)
ã®2ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆã€‚å…¨ä½“çš„ã«ã‚³ãƒ¼ãƒ‰å“è³ªã¯é«˜ã„ã§ã™ãŒã€ä»¥ä¸‹ã®å•é¡Œç‚¹ãƒ»ãƒªã‚¹ã‚¯ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚
---
ğŸ”´ é‡å¤§åº¦: é«˜
1. Mutexå†…ã§ã®Unlock/Re-lockãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ãƒ»ç«¶åˆãƒªã‚¹ã‚¯ï¼‰
ãƒ•ã‚¡ã‚¤ãƒ«: internal/worker/worker.go:327-339, 342-354, 375-388, 390-404
processBlackDetection ã¨ processSilenceDetection ã§ã€defer w.mu.Unlock() ã‚’è¨­å®šã—ãŸä¸Šã§ã€é–¢æ•°é€”ä¸­ã§ w.mu.Unlock() â†’ webhooké€ä¿¡ â†’
w.mu.Lock() ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š:
- deferæ™‚ã«äºŒé‡UnlockãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã¯ãªã„ãŒã€Unlockã€œre-Locké–“ã«åˆ¥ã®goroutineãŒçŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- é€”ä¸­ã§panicãŒç™ºç”Ÿã—ãŸå ´åˆã€deferã®UnlockãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„mutexã‚’Unlockã—ã¦ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ãƒ‹ãƒƒã‚¯ã‚’èµ·ã“ã™
2. ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ãªã—
ãƒ•ã‚¡ã‚¤ãƒ«: internal/manifest/manifest.go:158
FetchSegment ã§ io.ReadAll(resp.Body)
ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã‚µã‚¤ã‚ºåˆ¶é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ‚ªæ„ã®ã‚ã‚‹ã¾ãŸã¯ç•°å¸¸ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆæ•°GBï¼‰ã§OOMãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ç’°å¢ƒå¤‰æ•°ã«ç§˜å¯†éµã‚’å¹³æ–‡ã§æ¸¡ã—ã¦ã„ã‚‹
ãƒ•ã‚¡ã‚¤ãƒ«: internal/k8s/k8s.go:124
WEBHOOK_SIGNING_KEY ã¨ INTERNAL_API_KEY ãŒPodç’°å¢ƒå¤‰æ•°ã«å¹³æ–‡ã§è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚kubectl describe pod
ã§èª°ã§ã‚‚è¦‹ãˆã¦ã—ã¾ã„ã¾ã™ã€‚Kubernetes Secretã‚’ä½¿ã†ã¹ãã§ã™ã€‚
4. API Keyæ¯”è¼ƒãŒã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚¢ã‚¿ãƒƒã‚¯ã«è„†å¼±
ãƒ•ã‚¡ã‚¤ãƒ«: internal/httpapi/middleware.go:34, middleware.go:52
key != apiKey ã®æ–‡å­—åˆ—æ¯”è¼ƒã¯å®šæ•°æ™‚é–“ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚crypto/subtle.ConstantTimeCompare ã‚’ä½¿ã†ã¹ãã§ã™ã€‚
---
ğŸŸ  é‡å¤§åº¦: ä¸­
5. waitingMode ã§ info ãŒnilã®å ´åˆã®ãƒ‡ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
ãƒ•ã‚¡ã‚¤ãƒ«: internal/worker/worker.go:196
IsStreamLiveãŒã‚¨ãƒ©ãƒ¼ãªã—ã§ info ãŒ nil ã‚’è¿”ã™å ´åˆã€196è¡Œç›®ã® info.LiveStatus ã§nil pointer panicãŒç™ºç”Ÿã—ã¾ã™ã€‚IsStreamLive
ã®ç¾åœ¨ã®å®Ÿè£…ã§ã¯nilã«ãªã‚‰ãªã„ã§ã™ãŒã€å°†æ¥çš„ãªå¤‰æ›´ã§ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
6. Reconciliationæ™‚ã®å­¤å…Podåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®æŠœã‘
ãƒ•ã‚¡ã‚¤ãƒ«: internal/k8s/reconcile.go:137-151
dbMonitors ã¯ã€Œã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã€ãƒ¢ãƒ‹ã‚¿ãƒ¼ã®ã¿ã‚’å«ã‚€ãŸã‚ã€DBä¸Šã«completedã‚„stoppedã®ãƒ¢ãƒ‹ã‚¿ãƒ¼ãŒå­˜åœ¨ã—ã€ãã®PodãŒã¾ã å­˜åœ¨ã™ã‚‹å ´åˆã€zombieã§
ãªãorphanã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚orphanã¨ã—ã¦å‡¦ç†ã•ã‚Œã‚‹ãŸã‚å®Ÿå®³ã¯å°ã•ã„ã§ã™ãŒã€ãƒ­ã‚°ãŒä¸æ­£ç¢ºã«ãªã‚Šã¾ã™ã€‚
7. FFmpegã‚³ãƒãƒ³ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ç„¡è¦–
ãƒ•ã‚¡ã‚¤ãƒ«: internal/ffmpeg/ffmpeg.go:145, ffmpeg.go:204
_ = cmd.Run() ã§ã‚¨ãƒ©ãƒ¼ã‚’å®Œå…¨ã«ç„¡è¦–ã—ã¦ã„ã¾ã™ã€‚FFmpegãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚„signalã§çµ‚äº†ã—ãŸå ´åˆã€ç©ºã®çµæœã‚’ã€Œå•é¡Œãªã—ã€ã¨èª¤åˆ¤å®šã—ã¾ã™ã€‚ã‚³ãƒ³ãƒ†
ã‚¹ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã‚‚ç„¡è¦–ã•ã‚Œã¾ã™ã€‚
8. handleSegmentError ã§60ç§’çµŒéå¾Œã€æ¯å›webhooké€ä¿¡
ãƒ•ã‚¡ã‚¤ãƒ«: internal/worker/worker.go:440-444
60ç§’çµŒéå¾Œã‹ã¤ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã¾ã ãƒ©ã‚¤ãƒ–ã®å ´åˆã€åˆ†æé–“éš”ã”ã¨ã«ç¹°ã‚Šè¿”ã— alert.segment_error
webhookãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚1å›é€ä¿¡ã—ãŸã‚‰ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ã¹ãã§ã™ã€‚
9. contains é–¢æ•°ã®å†å®Ÿè£…
ãƒ•ã‚¡ã‚¤ãƒ«: internal/db/monitor_repository.go:463-474
æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® strings.Contains ã‚’ä½¿ãˆã°ååˆ†ã§ã™ã€‚è‡ªå‰å®Ÿè£…ã¯ä¸è¦ã§ã€ãƒã‚°ã®æ¸©åºŠã«ãªã‚Šã¾ã™ã€‚
10. Callback URLã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¸ååˆ†
ãƒ•ã‚¡ã‚¤ãƒ«: internal/api/handlers.go:86-88
url.ParseRequestURI ã¯ã‚¹ã‚­ãƒ¼ãƒ ç„¡ã—ã®URLã‚‚é€šã—ã¾ã™ï¼ˆä¾‹: ://maliciousï¼‰ã€‚HTTPã¾ãŸã¯HTTPSã‚¹ã‚­ãƒ¼ãƒ ã®ã¿ã‚’è¨±å¯ã™ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™
11. updated_at ã‚«ãƒ©ãƒ ãŒæ›´æ–°ã•ã‚Œãªã„
ãƒ•ã‚¡ã‚¤ãƒ«: internal/db/monitor_repository.go:265-267
UpdateStatus ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™ãŒã€updated_at ã‚’æ›´æ–°ã—ã¦ã„ã¾ã›ã‚“ã€‚DBãƒˆãƒªã‚¬ãƒ¼ãŒãªã„é™ã‚Šã€updated_at ã¯å¸¸ã«ä½œæˆæ™‚ã®ã¾ã¾ã§ã™ã€‚
---
ğŸŸ¡ é‡å¤§åº¦: ä½
12. RestartPolicy: OnFailure ã®å•é¡Œ
ãƒ•ã‚¡ã‚¤ãƒ«: internal/k8s/k8s.go:152
WorkerãŒæ­£å¸¸çµ‚äº†å¾Œã‚‚ OnFailure ãƒãƒªã‚·ãƒ¼ã ã¨Podã¯CompletedçŠ¶æ…‹ã§æ®‹ã‚Šç¶šã‘ã¾ã™ã€‚Never ã«ã™ã‚‹ã‹ã€Jobãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ã†æ–¹ãŒé©åˆ‡ã§ã™ã€‚
13. ListMonitorsã®statusãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
ãƒ•ã‚¡ã‚¤ãƒ«: internal/api/handlers.go:331-334
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ãã®ã¾ã¾ MonitorStatus
ã«ã‚­ãƒ£ã‚¹ãƒˆã—ã¦ãŠã‚Šã€ä¸æ­£ãªå€¤ã§ã‚‚SQLã‚¯ã‚¨ãƒªã«æ¸¡ã•ã‚Œã¾ã™ã€‚çµæœãŒ0ä»¶ã«ãªã‚‹ã ã‘ã§ã™ãŒã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã¹ãã§ã™ã€‚
14. Manifest refreshã®ç¡¬ç›´çš„ãª30ç§’é–“éš”
ãƒ•ã‚¡ã‚¤ãƒ«: internal/worker/worker.go:221
ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆURLæ›´æ–°é–“éš”ãŒ30ç§’ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚è¨­å®šå¯èƒ½ã«ã™ã¹ãã§ã™ã€‚
15. gracefulShutdown ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘Šãªã—
ãƒ•ã‚¡ã‚¤ãƒ«: internal/worker/worker.go:532-540
ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã‚ˆã‚‹åœæ­¢æ™‚ã«gatewayã¸ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å ±å‘ŠãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¢ãƒ‹ã‚¿ãƒ¼ãŒDBä¸Šã§æ°¸é ã«ã€Œmonitoringã€çŠ¶æ…‹ã®ã¾ã¾æ®‹ã‚‹å¯èƒ½æ€§ãŒ
ã‚ã‚Šã¾ã™ã€‚
16. DASHãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆæœªå®Ÿè£…
ãƒ•ã‚¡ã‚¤ãƒ«: internal/manifest/manifest.go:138
DASHå½¢å¼ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã ã‘ã§ã™ã€‚yt-dlpãŒDASH URLã‚’è¿”ã—ãŸå ´åˆã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãŒå¸¸ã«å¤±æ•—ã—ã¾ã™ã€‚
17. Worker metadataã®è¨­å®šæ¼ã‚Œ
ãƒ•ã‚¡ã‚¤ãƒ«: internal/worker/worker.go:64-75 vs cmd/worker/main.go
NewWorker ã§ã¯metadataãŒè¨­å®šã•ã‚Œã¾ã›ã‚“ã€‚cmd/worker/main.go ã§ SetMetadata
ã‚’å‘¼ã‚“ã§ã„ã‚‹ã‹ç¢ºèªãŒå¿…è¦ã§ã™ï¼ˆconfig.Metadataã‹ã‚‰è¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨æ¨æ¸¬ã•ã‚Œã¾ã™ãŒã€æ˜ç¤ºçš„ã«ç¢ºèªã™ã¹ãã§ã™ï¼‰ã€‚
---
ã¾ã¨ã‚
æœ€ã‚‚å„ªå…ˆåº¦ãŒé«˜ã„ä¿®æ­£å¯¾è±¡:
1. Mutex Unlock/Re-lockãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ webhooké€ä¿¡ã‚’mutexå¤–ã«å‡ºã™è¨­è¨ˆã«å¤‰æ›´
2. ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚µã‚¤ã‚ºåˆ¶é™ â†’ io.LimitReader ã§ä¸Šé™è¨­å®š
3. Secretç®¡ç† â†’ K8s Secretã‚’ä½¿ç”¨
4. API Keyæ¯”è¼ƒ â†’ subtle.ConstantTimeCompare ã«å¤‰æ›´
---
Security Review Report
Note
The working tree is clean with no pending changes. This review covers the existing codebase.
---
Vuln 1: SSRF via User-Controlled Webhook URL: internal/api/handlers.go:85
- Severity: High
- Confidence: 0.9
- Description: The callback_url field in the monitor creation endpoint is validated only for URL format using url.ParseRequestURI().
There is no validation of the destination host against private IP ranges (127.0.0.0/8, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16,
169.254.0.0/16). The URL flows directly to HTTP clients in internal/webhook/webhook.go:139 and internal/worker/callback.go:56-104,
which make requests to the user-supplied address from within the Kubernetes cluster.
- Exploit Scenario: An attacker with a valid API key creates a monitor with callback_url set to
http://169.254.169.254/latest/meta-data/iam/security-credentials/ (cloud metadata endpoint). When the worker pod reports status, it
sends HTTP requests to this internal address, potentially leaking cloud instance credentials or allowing access to internal services
not exposed to the internet.
- Recommendation: Add a URL validation function that resolves the hostname and checks the resulting IP against private/reserved ranges
(RFC 1918, link-local, loopback, metadata endpoints). Apply this check both at monitor creation time and before each outbound HTTP
request to prevent DNS rebinding attacks. Consider using an allowlist of permitted URL schemes (https only).        